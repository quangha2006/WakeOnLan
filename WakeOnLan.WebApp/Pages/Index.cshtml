@page "/"
@model WakeOnLan.WebApp.Pages.IndexModel
@{
    ViewData["Title"] = "Computers";
}

<div class="row justify-content-center">
    <div class="col-12 col-lg-9 col-xl-8">
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                @if (Model.Computers.Count == 0)
                {
                    <div class="alert alert-warning mb-0">
                        No computers configured for this account.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead>
                                <tr>
                                    <th style="width:70px">#</th>
                                    <th>Computer Name</th>
                                    <th style="width:140px" class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var c in Model.Computers)
                                {
                                    var statusId = $"status-{c.RowId}";
                                    var btnId = $"btn-{c.RowId}";
                                    <tr>
                                        <td class="text-muted">@c.RowId</td>
                                        <td>
                                            <div class="fw-semibold">@c.ComputerName</div>
                                            <div id="@statusId" class="small mt-1"></div>
                                        </td>
                                        <td class="text-end">
                                            <button id="@btnId"
                                                    class="btn btn-primary btn-sm"
                                                    onclick="wake(@c.RowId, '@c.ComputerName')">
                                                Wake
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script>
    function setStatus(rowId, type, text) {
      const el = document.getElementById(`status-${rowId}`);
      el.className = "small mt-1"; // reset
      if (type === "success") el.classList.add("text-success");
      if (type === "error") el.classList.add("text-danger");
      if (type === "info") el.classList.add("text-muted");
      el.textContent = text;
    }

    function setLoading(rowId, isLoading) {
      const btn = document.getElementById(`btn-${rowId}`);
      if (!btn) return;
      btn.disabled = isLoading;
      btn.textContent = isLoading ? "Waking..." : "Wake";
    }

    async function wake(rowId, computerName) {
      setLoading(rowId, true);
      setStatus(rowId, "info", "Sending magic packet...");

      try {
        const res = await fetch("/api/wol/wake-by-name", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ computerName })
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok) {
          setStatus(rowId, "success", data.message || "OK");
        } else {
          setStatus(rowId, "error", data.message || ("Error " + res.status));
        }
      } catch (e) {
        setStatus(rowId, "error", "Network error.");
      } finally {
        setLoading(rowId, false);
      }
    }
</script>
